// ÈõÖÂõæÁªÑ‰ª∂
WidgetMetadata = {
    id: "yatu",
    title: "ÈõÖÂõæ(ÊØèÊó•ÊîæÈÄÅ+ÁÇπÊí≠ÊéíË°åÊ¶ú+ËØÑÂàÜÊéíË°åÊ¶ú)",
    modules: [
        {
            title: "ÊØèÊó•ÊîæÈÄÅ",
            requiresWebView: false,
            functionName: "loadLatestItems",
            cacheDuration: 21600,
            params: [
                {
                    name: "genre",
                    title: "Á±ªÂûã",
                    type: "enumeration",
                    enumOptions: [
                        {
                            title: "Âä®Êº´",
                            value: "sin1",
                        },
                        {
                            title: "ÁîµÂΩ±",
                            value: "sin2",
                        },
                        {
                            title: "ÁîµËßÜÂâß",
                            value: "sin3",
                        },
                    ],
                },
                {
                    name: "start_date",
                    title: "ÂºÄÂßãÊó•ÊúüÔºönÂ§©ÂâçÔºà0Ë°®Á§∫‰ªäÂ§©Ôºå-1Ë°®Á§∫Êò®Â§©Ôºâ",
                    type: "input",
                    description: "0Ë°®Á§∫‰ªäÂ§©Ôºå-1Ë°®Á§∫Êò®Â§©ÔºåÊú™Â°´ÂÜôÊÉÖÂÜµ‰∏ãÊé•Âè£‰∏çÂèØÁî®",
                    placeholders: [
                        {
                            title: "‰ªäÂ§©",
                            value: "0"
                        },
                        {
                            title: "Êò®Â§©",
                            value: "-1"
                        },
                        {
                            title: "ÂâçÂ§©",
                            value: "-2"
                        },
                        {
                            title: "Â§ßÂâçÂ§©",
                            value: "-3"
                        },
                    ]
                },
                {
                    name: "days",
                    title: "Â§©Êï∞Ôºà‰ªéÂºÄÂßãÊó•ÊúüÂºÄÂßãÁöÑÂêéÈù¢mÂ§©ÁöÑÊï∞ÊçÆÔºâ",
                    type: "input",
                    description: "Â¶ÇÔºö3Ôºå‰ºöËøîÂõû‰ªéÂºÄÂßãÊó•ÊúüËµ∑ÁöÑ3Â§©ÂÜÖÁöÑËäÇÁõÆÔºåÊú™Â°´ÂÜôÊÉÖÂÜµ‰∏ãÊé•Âè£‰∏çÂèØÁî®",
                    value: "1",
                    placeholders: [
                        {
                            title: "1",
                            value: "1"
                        },
                        {
                            title: "2",
                            value: "2"
                        },
                        {
                            title: "3",
                            value: "3"
                        },
                        {
                            title: "4",
                            value: "4"
                        },
                    ]
                },
            ],
        },
        {
            title: "ÁÇπÊí≠ÊéíË°åÊ¶ú",
            requiresWebView: false,
            functionName: "loadClickItems",
            cacheDuration: 21600,
            params: [
                {
                    name: "genre",
                    title: "Á±ªÂûã",
                    type: "enumeration",
                    enumOptions: [
                        {
                            title: "ËøûËΩΩÂä®Êº´",
                            value: "dm-lz",
                        },
                        {
                            title: "ÂâßÂú∫Âä®Êº´",
                            value: "dm-jc",
                        },
                        {
                            title: "ÁîµÂΩ±",
                            value: "dy",
                        },
                        {
                            title: "È¶ôÊ∏ØÁîµÂΩ±",
                            value: "dy-xianggan",
                        },
                        {
                            title: "Ê¨ßÁæéÁîµÂΩ±",
                            value: "dy-om",
                        },
                        {
                            title: "ÁîµËßÜÂâß",
                            value: "tv",
                        },
                        {
                            title: "ÁæéÂâß",
                            value: "tv-meiju",
                        },
                        {
                            title: "ÁªºËâ∫",
                            value: "tv-zy",
                        },
                    ],
                },
                {
                    name: "sort_by",
                    title: "Êó∂Èó¥",
                    type: "enumeration",
                    enumOptions: [
                        {
                            title: "‰ªäÊó•",
                            value: "db_lz1",
                        },
                        {
                            title: "Êú¨Êúà",
                            value: "db_lz2",
                        },
                        {
                            title: "ÂéÜÂè≤",
                            value: "db_lz3",
                        },
                    ],
                },
            ],
        },
        {
            title: "ËØÑÂàÜÊéíË°åÊ¶ú",
            requiresWebView: false,
            functionName: "loadScoreItems",
            cacheDuration: 86400,
            params: [
                {
                    name: "genre",
                    title: "Á±ªÂûã",
                    type: "enumeration",
                    enumOptions: [
                        {
                            title: "Âä®Êº´",
                            value: "p-dm",
                        },
                        {
                            title: "ÁîµÂΩ±",
                            value: "p-dy",
                        },
                        {
                            title: "ÁîµËßÜÂâß",
                            value: "p-tv",
                        },
                    ],
                },
                {
                    name: "sort_by",
                    title: "Á≠âÁ∫ß",
                    type: "enumeration",
                    enumOptions: [
                        {
                            title: "ÈùûÂ∏∏Â•ΩÁúã",
                            value: "tv1",
                        },
                        {
                            title: "Â•ΩÁúã",
                            value: "tv2",
                        },
                        {
                            title: "‰∏ÄËà¨",
                            value: "tv3",
                        },
                        {
                            title: "ÁÉÇÁâá",
                            value: "tv4",
                        },
                    ],
                },
            ],
        },
    ],
    version: "1.0.1",
    requiredVersion: "0.0.1",
    description: "ÊåâÊØèÊó•ÁÉ≠ÁÇπÊàñÊéíË°åËé∑ÂèñÂΩ±ËßÜÈõÖÂõæ",
    author: "ùïèùïöùï™ùï¶ùïùùïöùï¶",
    site: "https://github.com/huangxd-/ForwardWidgets"
};

// Âü∫Á°ÄËé∑ÂèñTMDBÊï∞ÊçÆÊñπÊ≥ï
async function fetchTmdbData(key, mediaType) {
    const tmdbResults = await Widget.tmdb.get(`/search/${mediaType}`, {
        params: {
            query: key,
            language: "zh_CN",
        }
    });
    //ÊâìÂç∞ÁªìÊûú
    // console.log("ÊêúÁ¥¢ÂÜÖÂÆπÔºö" + key)
    // console.log("tmdbResults:" + JSON.stringify(tmdbResults, null, 2));
    // console.log("tmdbResults.total_results:" + tmdbResults.total_results);
    // console.log("tmdbResults.results[0]:" + tmdbResults.results[0]);
    return tmdbResults.results;
}

function getItemInfos(data, startDateInput, days, genre) {
    let docId = Widget.dom.parse(data);

    let tables = Widget.dom.select(docId, `table#${genre}`);

    if (!tables || tables.length === 0) {
        console.error(`Ê≤°ÊúâËß£ÊûêÂà∞Áõ∏Â∫îtable`);
        return null;
    }

    let tdElements = Widget.dom.select(tables[0], 'td');

    let today = new Date();
    let yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    let dayBeforeYesterday = new Date(today);
    dayBeforeYesterday.setDate(today.getDate() - 2);

    function formatDate(date) {
        let year = date.getFullYear().toString().slice(2); // Get last two digits
        let month = date.getMonth() + 1; // Months are 0-based
        let day = date.getDate();
        return `${year}/${month}/${day}`;
    }

    let results = [];

    tdElements.forEach(td => {
        // Get all text content within the td
        let tdContent = Widget.dom.text(td).trim();

        // Find the span with style="color:#666666;" for time information
        let timeSpan = Widget.dom.select(td, 'span[style="color:#666666;"]')[0];
        let timeText = timeSpan ? Widget.dom.text(timeSpan).trim() : '';

        // Process timeText
        let processedTime = timeText;
        if (/^\d{1,2}:\d{2}:\d{2}$/.test(timeText)) {
            // If time is in hh:mm:ss format, use today's date
            processedTime = formatDate(today);
        } else if (timeText === 'Êò®Â§©') {
            // If time is "Êò®Â§©", use yesterday's date
            processedTime = formatDate(yesterday);
        } else if (timeText === 'ÂâçÂ§©') {
            // If time is "ÂâçÂ§©", use day before yesterday's date
            processedTime = formatDate(dayBeforeYesterday);
        }

        // Extract the link and title from the <a> tag
        let linkEl = Widget.dom.select(td, 'a')[0];
        let linkHref = linkEl ? Widget.dom.attr(linkEl, 'href') : '';
        let linkText = linkEl ? Widget.dom.text(linkEl).trim() : '';

        // Extract the episode information from the span (if exists)
        let episodeSpan = Widget.dom.select(td, 'span:not([style])')[0];
        let episodeText = episodeSpan ? Widget.dom.text(episodeSpan).trim() : '';

        results.push({
            title: linkText.replace(/ *Á¨¨[^Â≠£]*Â≠£(?:~[^Â≠£]+Â≠£)?| *\d+~\d+Â≠£| *\d+Â≠£/, ''),
            link: linkHref,
            episodes: episodeText,
            time: processedTime,
            fullContent: tdContent
        });
    });

    console.log("results: ", results)

    today.setHours(0, 0, 0, 0); // ËßÑËåÉÂåñÊó∂Èó¥

    // ËÆ°ÁÆóÂºÄÂßãÂíåÁªìÊùüÊó•Êúü
    let startDate = new Date(today);
    startDate.setDate(today.getDate() + Number(startDateInput));
    startDate.setHours(0, 0, 0, 0);

    let endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + Number(days) - 1);
    endDate.setHours(0, 0, 0, 0);

    console.log("startDate: ", startDate);
    console.log("endDate: ", endDate);

    // ËøáÊª§ÁªìÊûú
    return results.filter(item => {
        // È™åËØÅÊó•ÊúüÊ†ºÂºè
        if (!item.time || !/^\d{1,2}\/\d{1,2}\/\d{2}$/.test(item.time)) {
            return false;
        }

        // Ëß£ÊûêÊó•ÊúüÔºåÂÅáËÆæÊ†ºÂºè‰∏∫ YY/MM/DD
        let [year, month, day] = item.time.split('/').map(Number);
        let currentYear = new Date().getFullYear();
        let century = Math.floor(currentYear / 100) * 100;
        // Â¶ÇÊûúÂπ¥‰ªΩÂ∞è‰∫éÁ≠â‰∫éÂΩìÂâçÂπ¥‰ªΩÁöÑ‰∏§‰ΩçÊï∞ÔºåÂÅáËÆæÊòØ 2000 Âπ¥‰ª£
        let fullYear = year <= (currentYear % 100) ? century + year : century - 100 + year;
        let itemDate = new Date(fullYear, month - 1, day);

        // Ê£ÄÊü•Êó•ÊúüÊúâÊïàÊÄß
        if (isNaN(itemDate)) return false;

        itemDate.setHours(0, 0, 0, 0);
        return itemDate >= startDate && itemDate <= endDate;
    });
}

async function loadLatestItems(params = {}) {
    try {
        const genre = params.genre || "";
        const startDateInput = params.start_date || "";
        const days = params.days || "";

        if (!genre || !startDateInput || !days) {
            throw new Error("ÂøÖÈ°ªÊèê‰æõÂàÜÁ±ª„ÄÅÂºÄÂßãÊó•Êúü„ÄÅÂ§©Êï∞");
        }

        const mediaTypeDict = {
            sin1: 'tv',
            sin2: 'movie',
            sin3: 'tv',
        };

        const response = await Widget.http.get("https://gist.githubusercontent.com/huangxd-/28a30eac8051ccb05a43c6f49a117286/raw/zuijin.asp", {
            headers: {
                "User-Agent":
                    "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",
            },
        });

        console.log("ËØ∑Ê±ÇÁªìÊûú:", response.data);

        const itemInfos = getItemInfos(response.data, startDateInput, days, genre);

        console.log("itemInfos:", itemInfos)

        const promises = itemInfos.map(async (itemInfo) => {
            // Ê®°ÊãüAPIËØ∑Ê±Ç
            const tmdbDatas = await fetchTmdbData(itemInfo.title, mediaTypeDict[genre])

            if (tmdbDatas.length !== 0) {
                return {
                    id: tmdbDatas[0].id,
                    type: "tmdb",
                    title: tmdbDatas[0].title ?? tmdbDatas[0].name,
                    description: tmdbDatas[0].overview,
                    releaseDate: tmdbDatas[0].release_date ?? tmdbDatas[0].first_air_date,
                    backdropPath: tmdbDatas[0].backdrop_path,
                    posterPath: tmdbDatas[0].poster_path,
                    rating: tmdbDatas[0].vote_average,
                    mediaType: mediaTypeDict[genre],
                };
            } else {
                return null;
            }
        });

        // Á≠âÂæÖÊâÄÊúâËØ∑Ê±ÇÂÆåÊàê
        const items = (await Promise.all(promises)).filter(Boolean);

        console.log(items)

        return items;
    } catch (error) {
        console.error("Â§ÑÁêÜÂ§±Ë¥•:", error);
        throw error;
    }
}

function getClickItemInfos(data, typ) {
    let docId = Widget.dom.parse(data);

    let tables = Widget.dom.select(docId, `table#${typ}`);

    if (!tables || tables.length === 0) {
        console.error(`Ê≤°ÊúâËß£ÊûêÂà∞Áõ∏Â∫îtable`);
        return null;
    }

    return [...new Set(
        Array.from(
            Widget.dom.select(tables[0], 'a[target="_blank"]')
        ).map(a => Widget.dom.text(a).trim().replace(/ *Á¨¨[^Â≠£]*Â≠£(?:~[^Â≠£]+Â≠£)?| *\d+~\d+Â≠£| *\d+Â≠£/, ''))
    )];
}

async function fetchFinalItems(genre, typ, mediaTypeDict, suffixDict) {
    const response = await Widget.http.get(`https://gist.githubusercontent.com/huangxd-/28a30eac8051ccb05a43c6f49a117286/raw/${genre}.${suffixDict[genre]}`, {
        headers: {
            "User-Agent":
                "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",
        },
    });

    console.log("ËØ∑Ê±ÇÁªìÊûú:", response.data);

    const itemInfos = getClickItemInfos(response.data, typ);

    console.log("itemInfos:", itemInfos)

    const promises = itemInfos.map(async (title) => {
        // Ê®°ÊãüAPIËØ∑Ê±Ç
        const tmdbDatas = await fetchTmdbData(title, mediaTypeDict[genre])

        if (tmdbDatas.length !== 0) {
            return {
                id: tmdbDatas[0].id,
                type: "tmdb",
                title: tmdbDatas[0].title ?? tmdbDatas[0].name,
                description: tmdbDatas[0].overview,
                releaseDate: tmdbDatas[0].release_date ?? tmdbDatas[0].first_air_date,
                backdropPath: tmdbDatas[0].backdrop_path,
                posterPath: tmdbDatas[0].poster_path,
                rating: tmdbDatas[0].vote_average,
                mediaType: mediaTypeDict[genre],
            };
        } else {
            return null;
        }
    });

    // Á≠âÂæÖÊâÄÊúâËØ∑Ê±ÇÂÆåÊàê
    const items = (await Promise.all(promises)).filter(Boolean);

    console.log(items)
    return items;
}

async function loadClickItems(params = {}) {
    try {
        const genre = params.genre || "";
        const typ = params.sort_by || "";

        if (!genre || !typ) {
            throw new Error("ÂøÖÈ°ªÊèê‰æõÂàÜÁ±ª„ÄÅÊó∂Èó¥");
        }

        const mediaTypeDict = {
            'dm-lz': 'tv',
            'dm-jc': 'movie',
            'dy': 'movie',
            'dy-xianggan': 'movie',
            'dy-om': 'movie',
            'tv': 'tv',
            'tv-meiju': 'tv',
            'tv-zy': 'tv',
        };

        const suffixDict = {
            'dm-lz': 'htm',
            'dm-jc': 'htm',
            'dy': 'htm',
            'dy-xianggan': 'html',
            'dy-om': 'htm',
            'tv': 'htm',
            'tv-meiju': 'html',
            'tv-zy': 'htm',
        };

        return await fetchFinalItems(genre, typ, mediaTypeDict, suffixDict);
    } catch (error) {
        console.error("Â§ÑÁêÜÂ§±Ë¥•:", error);
        throw error;
    }
}

async function loadScoreItems(params = {}) {
    try {
        const genre = params.genre || "";
        const typ = params.sort_by || "";

        if (!genre || !typ) {
            throw new Error("ÂøÖÈ°ªÊèê‰æõÂàÜÁ±ª„ÄÅÁ≠âÁ∫ß");
        }

        const mediaTypeDict = {
            'p-dm': 'tv',
            'p-dy': 'movie',
            'p-tv': 'tv',
        };

        const suffixDict = {
            'p-dm': 'htm',
            'p-dy': 'htm',
            'p-tv': 'htm',
        };

        return await fetchFinalItems(genre, typ, mediaTypeDict, suffixDict);
    } catch (error) {
        console.error("Â§ÑÁêÜÂ§±Ë¥•:", error);
        throw error;
    }
}
